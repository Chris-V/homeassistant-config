homeassistant:
  customize:
    binary_sensor.ups_battery_status:
      battery_type: "APC BR1500G RS 1500 12V"
    automation.notify_power_back:
      friendly_name: "Notify when power is back"
      icon: "mdi:message-settings-variant"
    automation.notify_power_outage:
      friendly_name: "Notify when power is out"
      icon: "mdi:message-settings-variant"
    automation.notify_ups_replace_battery:
      friendly_name: "Notify UPS battery status"
      icon: "mdi:message-settings-variant"
    automation.ups_power_off:
      friendly_name: "Power off devices when running on UPS battery"
    automation.ups_power_on:
      friendly_name: "Power on devices when not running on UPS battery"

group:
  ups:
    name: "UPS"
    icon: "mdi:power-plug"
    entities:
      - sensor.ups_status
      - sensor.ups_load
      - sensor.ups_battery
      - sensor.ups_input_voltage
      - sensor.ups_time_left
      - sensor.ups_time_on_battery

  all_batteries:
    entities:
      - binary_sensor.ups_battery_status

apcupsd:
  host: !secret ups_host
  port: !secret ups_port

binary_sensor:
  - platform: apcupsd
  - platform: template
    sensors:
      ups_battery_status:
        friendly_name: "UPS battery"
        value_template: "{{ 'REPLACEBATT' in states('sensor.ups_status') }}"
        device_class: "battery"

input_boolean:
  notify_power_changes:
    name: "Notify power state changes"
    icon: "mdi:message-settings-variant"

sensor:
  - platform: apcupsd
    resources:
      - bcharge # Battery Charge
      - linev # Input Voltage
      - loadpct # Load %
      - status
      - timeleft # Time Left on Battery
      - tonbatt # Time on Battery

automation:
  - alias: notify_power_back
    initial_state: True
    trigger:
      - platform: state
        entity_id: "binary_sensor.ups_online_status"
        to: "on"
    action:
      service: notify.admin
      data_template:
        title: "Power is Back"
        message: "UPS is running on power after a {{ relative_time(trigger.from_state.last_changed) }} outage."
        data:
          tag: "ups_state"

  - alias: notify_power_outage
    initial_state: True
    trigger:
      - platform: state
        entity_id: "binary_sensor.ups_online_status"
        to: "off"
    action:
      service: notify.admin
      data:
        title: "Power Outage"
        message: "UPS is running on battery. Media Server will shutdown in a minute."
        data:
          tag: "ups_state"

  - alias: notify_ups_replace_battery
    initial_state: True
    trigger:
      platform: state
      entity_id: "binary_sensor.ups_battery_status"
      to: "on"
    action:
      - service: persistent_notification.create
        data_template:
          title: "Replace {{ trigger.to_state.name }}"
          message: >-
            {{ trigger.to_state.name }} must be replaced.
            Search on Amazon: https://www.amazon.ca/s/?field-keywords=battery+{{ trigger.to_state.attributes.battery_type | replace(' ', '+') }}
          notification_id: "replace_battery_{{ trigger.to_state.entity_id | replace('.', '_') }}"
      - service: notify.admin
        data_template:
          title: "Replace {{ trigger.to_state.name }}"
          message: >-
            {{ trigger.to_state.name }} must be replaced.
            Search on Amazon.
          data:
            tag: "replace_battery_{{ trigger.to_state.entity_id | replace('.', '_') }}"
            url: "https://www.amazon.ca/s/?field-keywords=battery+{{ trigger.to_state.attributes.battery_type | replace(' ', '+') }}"

  - alias: ups_power_off
    initial_state: True
    trigger:
      platform: state
      entity_id: "binary_sensor.ups_online_status"
      to: "off"
      for:
        seconds: 70 # UPS is polled every 60 secs, this *must* be higher to outlast short power outages.
    condition:
      condition: state
      entity_id: input_boolean.notify_power_changes
      state: "on"
    action:
      service: switch.turn_off
      entity_id:
        - switch.network_media

  - alias: ups_power_on
    initial_state: True
    trigger:
      platform: state
      entity_id: "binary_sensor.ups_online_status"
      to: "on"
      for:
        seconds: 30 # Power can come back for a couple seconds then cut again. Been there done that.
    condition:
      condition: state
      entity_id: input_boolean.notify_power_changes
      state: "on"
    action:
      service: switch.turn_on
      entity_id:
        - switch.network_media
